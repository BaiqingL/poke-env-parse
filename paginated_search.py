import requests, json
from typing import List, Dict, Union
base_url = "https://replay.pokemonshowdown.com/api/replays/search?format=gen9randombattle&page=[PAGE_NUMBER]&sort=rating"
"""
Sample response:
][{"uploadtime":1719792149,"id":"gen9randombattle-2152949532","format":"[Gen 9] Random Battle","players":["MichaelderBeste2","drifttrick"],"rating":2547,"private":0,"password":null},{"uploadtime":1712684694,"id":"gen9randombattle-2099652333","format":"[Gen 9] Random Battle","players":["MichaelderBeste2","pokeblade☆101"],"rating":2547,"private":0,"password":null},{"uploadtime":1720261993,"id":"gen9randombattle-2156077866","format":"[Gen 9] Random Battle","players":["Referrals","MichaelderBeste2"],"rating":2533,"private":0,"password":null},{"uploadtime":1716305743,"id":"gen9randombattle-2127525323","format":"[Gen 9] Random Battle","players":["ye im very bad","MichaelderBeste2"],"rating":2532,"private":0,"password":null},{"uploadtime":1714168022,"id":"gen9randombattle-2112313608","format":"[Gen 9] Random Battle","players":["Aqua","Delta 2777"],"rating":2528,"private":0,"password":null},{"uploadtime":1714576645,"id":"gen9randombattle-2115561264","format":"[Gen 9] Random Battle","players":["MichaelderBeste2","pokeblade☆101"],"rating":2525,"private":0,"password":null},{"uploadtime":1716223727,"id":"gen9randombattle-2126856728","format":"[Gen 9] Random Battle","players":["ye im very bad","MichaelderBeste2"],"rating":2514,"private":0,"password":null},{"uploadtime":1713922569,"id":"gen9randombattle-2110208528","format":"[Gen 9] Random Battle","players":["pokeblade☆101","Lucius Artor"],"rating":2511,"private":0,"password":null},{"uploadtime":1713918222,"id":"gen9randombattle-2110174164","format":"[Gen 9] Random Battle","players":["pokeblade☆101","Lucius Artor"],"rating":2506,"private":0,"password":null},{"uploadtime":1715108941,"id":"gen9randombattle-2119905168","format":"[Gen 9] Random Battle","players":["Delta 2777","MichaelderBeste2"],"rating":2502,"private":0,"password":null},{"uploadtime":1713122307,"id":"gen9randombattle-2103376120","format":"[Gen 9] Random Battle","players":["Norman2!","pokeblade☆101"],"rating":2493,"private":0,"password":null},{"uploadtime":1713879269,"id":"gen9randombattle-2109745420","format":"[Gen 9] Random Battle","players":["Aqua","Delta 2777"],"rating":2492,"private":0,"password":null},{"uploadtime":1716842907,"id":"gen9randombattle-2131700216","format":"[Gen 9] Random Battle","players":["MichaelderBeste2","Delta 2777"],"rating":2489,"private":0,"password":null},{"uploadtime":1713520593,"id":"gen9randombattle-2106881006","format":"[Gen 9] Random Battle","players":["Boris Huang - YT","MichaelderBeste2"],"rating":2483,"private":0,"password":null},{"uploadtime":1721663036,"id":"gen9randombattle-2165415712","format":"[Gen 9] Random Battle","players":["Referrals","kandkad"],"rating":2482,"private":0,"password":null},{"uploadtime":1722903990,"id":"gen9randombattle-2174283453","format":"[Gen 9] Random Battle","players":["kandkad","HaunterBoy28"],"rating":2479,"private":0,"password":null},{"uploadtime":1725803985,"id":"gen9randombattle-2197139572","format":"[Gen 9] Random Battle","players":["paysa","lt111vz mdb2"],"rating":2478,"private":0,"password":null},{"uploadtime":1722979196,"id":"gen9randombattle-2174873559","format":"[Gen 9] Random Battle","players":["ezws","kandkad"],"rating":2476,"private":0,"password":null},{"uploadtime":1714356814,"id":"gen9randombattle-2113726288","format":"[Gen 9] Random Battle","players":["freezai","pokeblade☆101"],"rating":2475,"private":0,"password":null},{"uploadtime":1714156277,"id":"gen9randombattle-2112206530","format":"[Gen 9] Random Battle","players":["LT_Alt1","Aqua"],"rating":2471,"private":0,"password":null},{"uploadtime":1714948332,"id":"gen9randombattle-2118556577","format":"[Gen 9] Random Battle","players":["Delta 2777","pokeblade☆101"],"rating":2470,"private":0,"password":null},{"uploadtime":1714318722,"id":"gen9randombattle-2113384636","format":"[Gen 9] Random Battle","players":["pokeblade☆101","MichaelderBeste2"],"rating":2470,"private":0,"password":null},{"uploadtime":1725182055,"id":"gen9randombattle-2192220691","format":"[Gen 9] Random Battle","players":["Soren-sage","MichaelderBesteVGC"],"rating":2469,"private":0,"password":null},{"uploadtime":1722906242,"id":"gen9randombattle-2174303998","format":"[Gen 9] Random Battle","players":["Referrals","HaunterBoy28"],"rating":2469,"private":0,"password":null},{"uploadtime":1724608994,"id":"gen9randombattle-2187585455","format":"[Gen 9] Random Battle","players":["drifttrick","Teres bahji"],"rating":2466,"private":0,"password":null},{"uploadtime":1711503593,"id":"gen9randombattle-2089946975","format":"[Gen 9] Random Battle","players":["Referrals","MichaelderBeste2"],"rating":2465,"private":0,"password":null},{"uploadtime":1716498079,"id":"gen9randombattle-2129157490","format":"[Gen 9] Random Battle","players":["MichaelderBeste2","Delta 2777"],"rating":2464,"private":0,"password":null},{"uploadtime":1712786481,"id":"gen9randombattle-2100604806","format":"[Gen 9] Random Battle","players":["MichaelderBeste2","Referrals"],"rating":2464,"private":0,"password":null},{"uploadtime":1714946943,"id":"gen9randombattle-2118545428","format":"[Gen 9] Random Battle","players":["pokeblade☆101","Delta 2777"],"rating":2463,"private":0,"password":null},{"uploadtime":1713073764,"id":"gen9randombattle-2103028339","format":"[Gen 9] Random Battle","players":["Referrals","LT_Alt1"],"rating":2463,"private":0,"password":null},{"uploadtime":1713297685,"id":"gen9randombattle-2104939986","format":"[Gen 9] Random Battle","players":["MichaelderBeste2","Teres bahji"],"rating":2462,"private":0,"password":null},{"uploadtime":1714351452,"id":"gen9randombattle-2113679483","format":"[Gen 9] Random Battle","players":["pokeblade☆101","MichaelderBeste2"],"rating":2460,"private":0,"password":null},{"uploadtime":1713718149,"id":"gen9randombattle-2108424504","format":"[Gen 9] Random Battle","players":["Aqua","BillyFan302"],"rating":2459,"private":0,"password":null},{"uploadtime":1718140318,"id":"gen9randombattle-2141473809","format":"[Gen 9] Random Battle","players":["MasterJ007","ceru➷edge➹"],"rating":2458,"private":0,"password":null},{"uploadtime":1722977810,"id":"gen9randombattle-2174863944","format":"[Gen 9] Random Battle","players":["kandkad","ezws"],"rating":2457,"private":0,"password":null},{"uploadtime":1722894083,"id":"gen9randombattle-2174199330","format":"[Gen 9] Random Battle","players":["kandkad","ezws"],"rating":2457,"private":0,"password":null},{"uploadtime":1714278428,"id":"gen9randombattle-2113141898","format":"[Gen 9] Random Battle","players":["freezai","LT_Alt1"],"rating":2455,"private":0,"password":null},{"uploadtime":1720632853,"id":"gen9randombattle-2158561491","format":"[Gen 9] Random Battle","players":["Pedrocini","Referrals"],"rating":2453,"private":0,"password":null},{"uploadtime":1716497004,"id":"gen9randombattle-2129151602","format":"[Gen 9] Random Battle","players":["Teres bahji","Delta 2777"],"rating":2452,"private":0,"password":null},{"uploadtime":1725555626,"id":"gen9randombattle-2195206358","format":"[Gen 9] Random Battle","players":["Teres bahji","MichaelderBesteVGC"],"rating":2450,"private":0,"password":null},{"uploadtime":1718282677,"id":"gen9randombattle-2142489462","format":"[Gen 9] Random Battle","players":["ceru-edge","PTKmoekyuun"],"rating":2449,"private":0,"password":null},{"uploadtime":1713087440,"id":"gen9randombattle-2103100982","format":"[Gen 9] Random Battle","players":["Lucius artor","MichaelderBeste2"],"rating":2449,"private":0,"password":null},{"uploadtime":1720261147,"id":"gen9randombattle-2156071840","format":"[Gen 9] Random Battle","players":["JustOut459","MichaelderBeste2"],"rating":2448,"private":0,"password":null},{"uploadtime":1722910437,"id":"gen9randombattle-2174342954","format":"[Gen 9] Random Battle","players":["ball enthusiast","Referrals"],"rating":2447,"private":0,"password":null},{"uploadtime":1722861554,"id":"gen9randombattle-2173893103","format":"[Gen 9] Random Battle","players":["Delta 2777","cacahue"],"rating":2447,"private":0,"password":null},{"uploadtime":1717010966,"id":"gen9randombattle-2133050475","format":"[Gen 9] Random Battle","players":["ye im very bad","Sylveon is so cute"],"rating":2447,"private":0,"password":null},{"uploadtime":1719349561,"id":"gen9randombattle-2149997026","format":"[Gen 9] Random Battle","players":["Petros","Michielleus"],"rating":2446,"private":0,"password":null},{"uploadtime":1723143284,"id":"gen9randombattle-2176173110","format":"[Gen 9] Random Battle","players":["PTKmoekyuun","xceloh"],"rating":2445,"private":0,"password":null},{"uploadtime":1721502711,"id":"gen9randombattle-2164402413","format":"[Gen 9] Random Battle","players":["Batram","teres bahji"],"rating":2444,"private":0,"password":null},{"uploadtime":1713428279,"id":"gen9randombattle-2106071475","format":"[Gen 9] Random Battle","players":["Referrals","soTsoT"],"rating":2444,"private":0,"password":null},{"uploadtime":1725387110,"id":"gen9randombattle-2193837014","format":"[Gen 9] Random Battle","players":["MichaelderBesteVGC","Delta 2777"],"rating":2443,"private":0,"password":null}]
"""

# Just want the id of the replay
def get_replays(page_number: int) -> List[Dict[str, Union[str, int]]]:
    url = base_url.replace("[PAGE_NUMBER]", str(page_number))
    response = requests.get(url)
    data = response.text[1:]

    data = json.loads(data)
    return [{"rating": replay['rating'], "id": replay['id']} for replay in data]

# keep grabbing pages until we get a replay with a rating less than 1800
replays = []
page_number = 1
continue_loop = True
while continue_loop:
    new_replays = get_replays(page_number)
    replays.extend(new_replays)
    rating = replays[-1]["rating"]
    if rating < 2200 or len(new_replays) == 0:
        continue_loop = False
    page_number += 1
    print(f"Grabbed page {page_number} now with {len(replays)} replays total with rating {rating}")

print(f"Found {len(replays)} replays with rating >= 2200")
with open('data/replays.jsonl', 'w') as outfile:
    for entry in replays:
        json.dump(entry, outfile)
        outfile.write('\n')